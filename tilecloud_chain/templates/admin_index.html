<!DOCTYPE html>
<html lang="en">
  <head>
    <title>The tile generation admin interface</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css"
      integrity="sha512-GQGU0fMMi238uA+a/bdWJfpUGKUkBdgfFdgBm72SUQ6BeyWjoY/ton0tEjH+OSH9iP4Dfh+7HM0I9f5eR0L/4w=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <style>
      a {
        text-decoration: none;
      }
      a:hover {
        text-decoration: underline;
      }
    </style>
  </head>
  <body class="px-5 py-4">
    <h1 class="bd-title">Tile generation</h1>
    %if not auth and auth_type == AuthenticationType.SECRET:
    <form>
      Secret: <input type="password" name="secret" />
      <input type="submit" value="OK" />
    </form>
    %elif not auth and auth_type == AuthenticationType.GITHUB:
    <a class="btn btn-primary" href="${github_auth_url}">Login with GitHub</a>
    %elif auth_type == AuthenticationType.GITHUB:
    <h2>Authentication</h2>
    <p>
      Logged as: <a href="${user_url}">${user_name}</a><br />
      <a class="btn btn-primary" href="${logout_url}">Logout</a>
    </p>
    %endif
    <span></span>
    %if has_access:
    <hr />
    <h2>Status</h2>
    <p>${'<br />'.join(status)|n}</p>
    <hr />
    <h2>Launch generation</h2>
    <form id="command-form" class="form-inline">
      <label for="staticEmail2" class="sr-only">Command</label>
      <div class="input-group mb-3">
        <input id="command" type="text" name="command" class="form-control" placeholder="Command" />

        <div class="input-group-append">
          <button type="submit" class="btn btn-outline-primary mb-2">Start</button>
        </div>
      </div>
      %if secret is not None:
      <input type="hidden" name="secret" value="${secret}" />
      %endif
    </form>
    <p>
      %for command in commands:
      <button class="btn btn-outline-primary command" data-role="${command.get('command', '')}">
        ${command.get('name', 'Unnamed')}
      </button>
      %endfor
    </p>
    %endif
    <span id="result"></span>

    <hr />
    <h2>Test</h2>
    <p>See the result in <a href="/${admin_path}/test">the test page</a>.</p>

    <script
      src="https://code.jquery.com/jquery-3.6.0.slim.min.js"
      integrity="sha256-u7e5khyithlIdTpu22PHhENmPcRdFiHRjhAuHcs05RI="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/2.11.5/umd/popper.min.js"
      integrity="sha512-8cU710tp3iH9RniUh6fq5zJsGnjLzOWLWdZqBMLtqaoZUA6AWIE34lwMB3ipUNiTBP5jEZKY95SfbNnQ8cCKvA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js"
      integrity="sha384-VHvPCCyXqtD5DqJeNxl2dtTyhF78xXNXdkwX1CZeRusQfRKp+tA7hAShOK/B/fQ2"
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script>
      $(document).ready(function () {
        $('.command').click((handler) => {
          $('#command').val(handler.target.dataset.role);
        });
        $('#command-form').submit((event) => {
          $('#result').html('');
          event.preventDefault();

          fetch('${run_url}', {
            body: new FormData(document.getElementById('command-form')),
            method: 'POST',
          })
            .then((response) => {
              return response.json();
            })
            .then((data) => {
              if (data.error) {
                $('#result').html(
                  `<p class="alert alert-danger" role="alert">${'$'}{data.error.replaceAll('\n', '<br/>')}</p>`
                );
              } else {
                if (data.returncode == 0) {
                  if (data['stdout'] || data['stderr']) {
                    $('#result').html(
                      `<p class="alert alert-success" role="alert">${'$'}{data.stdout.replaceAll('\n', '<br/>')}${'$'}{data.stderr.replaceAll('\n', '<br/>')}</p>`
                    );
                  } else {
                    $('#result').html(`<p class="alert alert-success" role="alert">Success</p>`);
                  }
                } else {
                  $('#result').html(
                    `<p class="alert alert-danger" role="alert">Return code: ${'$'}{data.returncode}<br/>${'$'}{data.stdout.replaceAll('\n', '<br/>')}<br/>${'$'}{data.stderr.replaceAll('\n', '<br/>')}</p>`
                  );
                }
              }
            })
            .catch((error) => {
              console.error(error);
              $('#result').html(`<div class="alert alert-danger" role="alert">${'$'}{error}</div>`);
            });
        });
      });
    </script>
  </body>
</html>
