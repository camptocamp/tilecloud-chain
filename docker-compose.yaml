version: '2.2'

services:
  db:
    image: camptocamp/postgres:14-postgis-3
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: tests
    volumes:
      - ./docker/test-db:/docker-entrypoint-initdb.d:ro

  mapserver:
    image: camptocamp/mapserver:8.0
    environment:
      MS_DEBUGLEVEL: '5'
      MAPSERVER_CATCH_SEGV: '1'
      MS_MAPFILE: /etc/mapserver/mapserver.map
    volumes:
      - ./docker/mapfile-docker:/etc/mapserver:ro
    links:
      - db:db
    user: www-data

  redis_master:
    image: redis:7.0.13

  redis_slave:
    image: redis:7.0.13
    command: redis-server --slaveof redis_master 6379
    depends_on:
      - redis_master

  redis_sentinel:
    image: camptocamp/c2cwsgiutils-redis-sentinel:6
    environment:
      - MASTER_NAME=mymaster
      - QUORUM=1
      - MASTER=redis_master
    depends_on:
      - redis_master

  application: &app
    image: camptocamp/tilecloud-chain
    environment: &app-env
      TILECLOUD_LOG_LEVEL: DEBUG
      TILECLOUD_CHAIN_LOG_LEVEL: DEBUG
      TILECLOUD_CHAIN_SESSION_SECRET: '1234'
      TILECLOUD_CHAIN_SESSION_SALT: '1234'
      C2C_AUTH_GITHUB_REPOSITORY: camptocamp/tilecloud-chain
      C2C_AUTH_GITHUB_SECRET: '1234567890123456789'
      C2C_AUTH_GITHUB_CLIENT_ID: '1234'
      C2C_AUTH_GITHUB_CLIENT_SECRET: '1234'
    links:
      - db
      - mapserver
      - redis_sentinel
    volumes:
      - ./example/tilegeneration/config.yaml:/etc/tilegeneration/config.yaml:ro

  app_test_user:
    <<: *app
    environment:
      <<: *app-env
      TEST_USER: Test

  test:
    image: camptocamp/tilecloud-chain-tests
    working_dir: /app
    environment:
      CI: 'true'
      TESTS: 'true'
      PGPASSWORD: postgres
      TILE_NB_THREAD: 2
      METATILE_NB_THREAD: 2
      SERVER_NB_THREAD: 2
      TILECLOUD_LOG_LEVEL: DEBUG
      TILECLOUD_CHAIN_LOG_LEVEL: DEBUG
    command:
      - sleep
      - infinity
    links:
      - db
      - mapserver
      - redis_sentinel
    volumes:
      - ./results:/results
      - ./tilecloud_chain:/app/tilecloud_chain
      # - ../tilecloud/tilecloud:/usr/local/lib/python3.8/dist-packages/tilecloud
